
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deploying From CodePipeline to OpsWorks Using a Custom Action and Lambda - :HIPSTER_DEV_BLOG</title>
  <meta name="author" content="Tim B.">

  
  <meta name="description" content="AWS recently released CodePipeline after announcing it last year. After doing the
setup walkthrough I was surprised
to see only the following &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hipsterdevblog.com/blog/2015/07/28/deploying-from-codepipeline-to-opsworks-using-a-custom-action-and-lambda">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title=":HIPSTER_DEV_BLOG" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-52141399-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">:HIPSTER_DEV_BLOG</a></h1>
  
    <h2>Another Octopress blog about programming and infrastructure.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hipsterdevblog.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/hire-me" class="green-btn">Hire Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Deploying From CodePipeline to OpsWorks Using a Custom Action and Lambda</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-28T20:40:42+10:00" pubdate data-updated="true">Jul 28<sup>th</sup>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>AWS recently released <a href="http://aws.amazon.com/codepipeline/">CodePipeline</a> after announcing it last year. After doing the
<a href="http://docs.aws.amazon.com/codepipeline/latest/userguide/getting-started-w.html">setup walkthrough</a> I was surprised
to see only the following deployment options!</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/deployopts.jpg"></p>

<p>I&rsquo;m sure other integrations are in the works, but fortunately
 CodePipeline supports <a href="http://docs.aws.amazon.com/codepipeline/latest/userguide/how-to-create-custom-action.html">custom actions</a>
 allowing you to build your own integrations in the mean time.</p>

<p>If you were hoping to see this:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/actionopts.png"></p>

<p>Then read on!</p>

<p>I&rsquo;ve implemented a custom action to deploy to OpsWorks using Lambda, you can find the full source of the Lambda
function <a href="https://github.com/Tim-B/codepipeline-opsworks-deployer">on GitHub</a>. It leverages the fact that CodePipeline
uses S3 to store artifacts between stages to trigger the Lambda function, and SNS retry behaviour for polling.</p>

<p>This blog posts explains how to configure your pipleine and the Lambda function to deploy to OpsWorks using CodePipeline.</p>

<!-- more -->


<h1>Overview</h1>

<p>Here&rsquo;s a sequence diagram of how this Lambda powered CodePipeline action works:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/codepipelineopsworks-diagram.png"></p>

<h1>Getting started</h1>

<h2>Create an initial pipeline</h2>

<p>If you haven&rsquo;t done so already, I&rsquo;d recommend creating an initial pipeline in CodePipeline. This will setup a bucket
such as <code>codepipeline-us-east-1-1234567890</code> which you&rsquo;ll need to configure later.</p>

<h2>Create an SNS topic</h2>

<p>You&rsquo;ll need an SNS topic which is used to poll both the CodePipeline task queue and the OpsWorks deployment status.</p>

<p>Once created, edit the &ldquo;Topic Delivery Policy&rdquo;, go to &ldquo;Advanced View&rdquo; and set the following JSON policy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'> <span class="p">{</span>
</span><span class='line'>   <span class="nt">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="nt">&quot;defaultHealthyRetryPolicy&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;minDelayTarget&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;maxDelayTarget&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;numRetries&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;numMaxDelayRetries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;numNoDelayRetries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;numMinDelayRetries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;backoffFunction&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>     <span class="nt">&quot;disableSubscriptionOverrides&quot;</span><span class="p">:</span> <span class="kc">false</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will retry (poll) every 30 seconds up to 20 times (10 minutes).</p>

<h2>Create OpsWorks artifact bucket</h2>

<p>Create a new S3 bucket where you&rsquo;ll store the final artifacts which will be deployed to OpsWorks. You could use the
 CodePipeline bucket, but I&rsquo;d recommend making a separate one to simplify things. Mine is called <code>opsworks-artifacts</code>.</p>

<h2>Configure your OpsWorks stack</h2>

<p>Create an OpsWorks stack with an application that deploys from an S3 archive in your OpsWorks artifact bucket.
The zip file name will be the name of the artifact in CodePipeline, I&rsquo;ve called mine <code>opsworks.zip</code>.</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/opsworks_app.png"></p>

<h2>Create Lambda IAM role</h2>

<p>From the IAM console create a new role, select &ldquo;AWS Lambda&rdquo; as the type.</p>

<p>Skip adding a managed policy, but add the following policy as an inline policy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;Statement&quot;</span><span class="p">:[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;Action&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;s3:Put*&quot;</span>
</span><span class='line'>         <span class="p">],</span>
</span><span class='line'>         <span class="nt">&quot;Resource&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;arn:aws:s3:::{OpsWorks artifact bucket}/*&quot;</span>
</span><span class='line'>         <span class="p">]</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;Action&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;opsworks:CreateDeployment&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;opsworks:DescribeDeployments&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;opsworks:DescribeLayers&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;opsworks:DescribeInstances&quot;</span>
</span><span class='line'>         <span class="p">],</span>
</span><span class='line'>         <span class="nt">&quot;Resource&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;{OpsWorks stack ARN}&quot;</span>
</span><span class='line'>         <span class="p">]</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;Action&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;SNS:Publish&quot;</span>
</span><span class='line'>         <span class="p">],</span>
</span><span class='line'>         <span class="nt">&quot;Resource&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;{SNS poll topic ARN}&quot;</span>
</span><span class='line'>         <span class="p">]</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;Action&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;codepipeline:PollForJobs&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;codepipeline:PutJob*&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;codepipeline:AcknowledgeJob&quot;</span>
</span><span class='line'>         <span class="p">],</span>
</span><span class='line'>         <span class="nt">&quot;Resource&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;*&quot;</span>
</span><span class='line'>         <span class="p">]</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;Action&quot;</span><span class="p">:[</span>
</span><span class='line'>            <span class="s2">&quot;logs:*&quot;</span>
</span><span class='line'>         <span class="p">],</span>
</span><span class='line'>         <span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:logs:*:*:*&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Be sure to replace <code>{OpsWorks artifact bucket}</code>, <code>{OpsWorks stack ARN}</code> and <code>{SNS Topic ARN}</code> with appropriate values
for the resources created above.</p>

<h2>Create a new Lambda function</h2>

<p>Create a new Lambda function from the Lambda console and select the &ldquo;Hello World&rdquo; template.</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/lambda_top.png"></p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/lambda_bottom.png"></p>

<p>Select the IAM role you created above. I set the memory and timeout as 128MB and 30s, but keep in mind the Lambda
function needs to copy a zip file between buckets so you might need to increase this if you have a large artifact.</p>

<h2>Link SNS event source</h2>

<p>Once you&rsquo;ve created the lambda function, click the &ldquo;Event sources&rdquo; tab, click &ldquo;Add event source&rdquo; and link the SNS
topic you created above.</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/lambda_sns.png"></p>

<p>You can leave it disabled for the moment.</p>

<h2>Subscribe SNS to events for CodePipeline bucket</h2>

<p>Go to the S3 bucket automatically created by CodePipeline, it should be named like <code>codepipeline-us-east-1-1234567890</code>.
Under the events section of the properties, subscribe the SNS topic you created above:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/snss3subscribe.png"></p>

<h2>Create pipeline</h2>

<p>Now you can actually create your pipeline in CodePipeline. You may need to create a dummy CodeDeploy stage otherwise
 the CodePipeline wizard won&rsquo;t let you finish:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/empty_pipeline.png"></p>

<h1>Create Custom Action</h1>

<p>Custom actions don&rsquo;t seem to be editable via the console yet, so you&rsquo;ll have to add the action via the CLI.</p>

<p>Save the following to a file:</p>

<figure class='code'><figcaption><span>input.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;Deploy&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;provider&quot;</span><span class="p">:</span> <span class="s2">&quot;OpsWorks-Via-Lambda&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;configurationProperties&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Deploy-Bucket&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;secret&quot;</span><span class="p">:</span> <span class="kc">false</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;OpsWorks-Stack-ID&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;secret&quot;</span><span class="p">:</span> <span class="kc">false</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;OpsWorks-App-ID&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;secret&quot;</span><span class="p">:</span> <span class="kc">false</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;inputArtifactDetails&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;minimumCount&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;maximumCount&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;outputArtifactDetails&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;minimumCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;maximumCount&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws codepipeline create-custom-action-type --cli-input-json file://input.json
</span></code></pre></td></tr></table></div></figure>


<p>Now when you reload the console and edit the pipeline you should be able to select the new <code>OpsWorks-Via-Lambda</code> deployment
 action in the list.</p>

<p>Fill out the details and save the pipeline:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/action-settings.png"></p>

<h1>Uploading Lambda function</h1>

<p>Download or fork my Lambda function on GitHub: <a href="https://github.com/Tim-B/codepipeline-opsworks-deployer">https://github.com/Tim-B/codepipeline-opsworks-deployer</a>.</p>

<p>Open the <code>Gruntfile.js</code> and update the specified <code>lambda_deploy</code> arn value with the ARN of your lambda function.</p>

<p>Run an <code>npm install</code>.</p>

<p>Then run <code>grunt deploy</code>.</p>

<p>You should see something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Running "lambda_package:default" (lambda_package) task
</span><span class='line'>codepipeline-opsworks-deployer@0.0.0 ../../../../../tmp/1438081544032.7822/node_modules/codepipeline-opsworks-deployer
</span><span class='line'>Created package at ./dist/codepipeline-opsworks-deployer_0-0-0_2015-6-28-21-5-44.zip
</span><span class='line'>
</span><span class='line'>Running "lambda_deploy:default" (lambda_deploy) task
</span><span class='line'>Uploading...
</span><span class='line'>Package deployed.
</span><span class='line'>No config updates to make.
</span><span class='line'>
</span><span class='line'>Done, without errors.</span></code></pre></td></tr></table></div></figure>


<p>If you go back to the Lambda console you should see the code has been uploaded:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/code_uploaded.png"></p>

<p>Finally, go back to the &ldquo;Event sources&rdquo; tab of the Lambda and update the SNS source state to Enabled.</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/enable-sns.png"></p>

<h1>Testing pipeline</h1>

<p>You should now be ready to test the pipeline! Click &ldquo;Release change&rdquo;.</p>

<p>After a minute or so your OpsWorks deployment should change to &ldquo;In Progress&rdquo;:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/deploying.png"></p>

<p>You should soon see a new deployment in OpsWorks:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/opsworks-status.png"></p>

<p>When that changes to done:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/opsworks_running.png"></p>

<p>The status in CodePipeline should change to &ldquo;Succeeded&rdquo;:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/deploy_done.png"></p>

<p>It&rsquo;s normal for there to be a 30 second - 1 minute delay between events showing up in CodePipeline due to the polling
involved.</p>

<h2>Failures</h2>

<p>The Lambda function should pass most failures back to CodePipeline too, if you see a failure:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/failed.png"></p>

<p>Click the &ldquo;Details&rdquo; link and you should see a message:</p>

<p style="text-align:center;"> <img src="/images/posts/opsworks_codepipeline/failed_message.png"></p>

<p>You can of course also check the Lambda status. By default it should also automatically fail deployments that take
longer than 9 minutes.</p>

<h1>Taking it further</h1>

<p>The next step would be to add additional build or testing stages between Source and Production. For example, you could
deploy to a staging stack, then run load tests against the staging stack, before deploying to your production stack
if the load tests pass.</p>

<p>You should also be able to adapt this technique to other deployment and build processes besides OpsWorks. You could even
use CodePipeline to deploy your OpsWorks Chef code by adapting the Lambda function to create a Kitchen test action,
then a run setup command action.</p>

<p>As usual, feedback and pull request are welcomed!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Tim B.</span></span>

      








  


<time datetime="2015-07-28T20:40:42+10:00" pubdate data-updated="true">Jul 28<sup>th</sup>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/codepipeline/'>codepipeline</a>, <a class='category' href='/blog/categories/lambda/'>lambda</a>, <a class='category' href='/blog/categories/opsworks/'>opsworks</a>, <a class='category' href='/blog/categories/sns/'>sns</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://hipsterdevblog.com/blog/2015/07/28/deploying-from-codepipeline-to-opsworks-using-a-custom-action-and-lambda/" data-via="" data-counturl="http://hipsterdevblog.com/blog/2015/07/28/deploying-from-codepipeline-to-opsworks-using-a-custom-action-and-lambda/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/05/30/analysing-dynamodb-index-usage-in-hive-queries/" title="Previous Post: Analysing DynamoDB index usage in Hive queries">&laquo; Analysing DynamoDB index usage in Hive queries</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/28/deploying-from-codepipeline-to-opsworks-using-a-custom-action-and-lambda/">Deploying From CodePipeline to OpsWorks Using a Custom Action and Lambda</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/30/analysing-dynamodb-index-usage-in-hive-queries/">Analysing DynamoDB Index Usage in Hive Queries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/21/building-zeroc-ice-projects-with-gradle-and-intellij/">Building ZeroC Ice 3.5 Projects With Gradle and IntelliJ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/01/part-2-exporting-and-analysing-cloudwatch-logs-with-data-pipeline-and-emr/">Part 2: Exporting and Analysing CloudWatch Logs With Data Pipeline and EMR</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/24/part-1-exporting-and-analysing-cloudwatch-logs-with-data-pipeline-and-emr/">Part 1: Exporting and Analysing CloudWatch Logs With Data Pipeline and EMR</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015.
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> and
    <a href="https://github.com/vladigleba/readify">Readify</a></span>.
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hipsterdevblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://hipsterdevblog.com/blog/2015/07/28/deploying-from-codepipeline-to-opsworks-using-a-custom-action-and-lambda/';
        var disqus_url = 'http://hipsterdevblog.com/blog/2015/07/28/deploying-from-codepipeline-to-opsworks-using-a-custom-action-and-lambda/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
